---
title: "renderToPipeableStreamã¨Honoã‚’çµ„ã¿åˆã‚ã›ã¦SSRã‚’ã—ãŸ"
description: "åŸºæœ¬SSRã¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«é ¼ã£ã¦å®Ÿè£…ã—ã¦ããŸã®ã§ã€å‹‰å¼·ã®ãŸã‚ã«è‡ªåˆ†ã§å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸ"
date: "2024/06/17"
published: true
---

## Intro

`renderToPipeableStream`ã‚’ä½¿ã£ãŸSSRã‚’è¡Œã†éš›ã®ã‚µãƒ¼ãƒãƒ¼ã«Honoã‚’ä½¿ã„ã¾ã—ãŸã€‚ã‚ã‚“ã¾ã‚Šèª¿ã¹ã¦ã‚‚è¨˜äº‹å‡ºã¦ã“ãªãã¦ã€[epicweb-dev/react-server-components](https://github.com/epicweb-dev/react-server-components/blob/2e3b78486baa9e04aa078c32430d8390acd32e48/exercises/05.actions/02.problem.client/server/app.js#L46-L57)ã‚’ã¿ã¦ã¾ã—ãŸã€‚
æœãŸã—ã¦ã“ã‚“ãªå®Ÿè£…ã‚’ä»Šæ™‚ã™ã‚‹æ–¹ãŒã©ã‚Œãã‚‰ã„ã„ã‚‹ã‹ã¯çŸ¥ã‚Šã¾ã›ã‚“ãŒãƒ¡ãƒ¢ç¨‹åº¦ã«æ®‹ã—ã¦ãŠãã¾ã™ã€‚

[https://github.com/yossydev/renderToPipeableStream-with-hono](https://github.com/yossydev/renderToPipeableStream-with-hono)ã¨ã„ã†ãƒªãƒã‚¸ãƒˆãƒªã«å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã™ã€‚

## `renderToPipeableStream`

Reactã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’Streamã§è¿”ã™ã‚ˆã†ã«ã§ãã‚‹APIã§ã™ã€‚
Node.jsã«ä¾å­˜ã—ã¦ã„ã‚‹ã®ã§ã€Denoãªã©ã®ä»–ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§å‹•ã‹ã—ãŸã„å ´åˆã¯`renderToReadableStream`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

## å†…å®¹

è‡ªåˆ†ãŒå®Ÿè£…ã—ãŸã‚µãƒ¼ãƒãƒ¼å´ã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’å…ƒã«ã©ã®ã‚ˆã†ã«å®Ÿè£…ã—ãŸã‹ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚
`renderToPipeableStream`ã®ç¬¬ä¸€å¼•æ•°ã«æ¸¡ã—ã¦ã„ã‚‹ã®ã¯æœ¬å½“ã«ãŸã ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãªã®ã§ã“ã“ã‚‰è¾ºã®èª¬æ˜ã¯çœãã¾ã™ã€‚


```js
import { Hono } from "hono";
import React from "react";
import ReactDOMServer from "react-dom/server";
import App from "../client/App";
import Layout from "../client/HTML";
import { serve } from "@hono/node-server";
import { RESPONSE_ALREADY_SENT } from "@hono/node-server/utils/response";
import { serveStatic } from "@hono/node-server/serve-static";

const app = new Hono();

app.use("/*", serveStatic({ root: "./dist", index: "" }));

app.get("/*", (c) => {
	const { pipe } = ReactDOMServer.renderToPipeableStream(
		<Layout>
			<App />
		</Layout>,
	);
	pipe(c.env.outgoing);
	return RESPONSE_ALREADY_SENT;
});

serve({ fetch: app.fetch, port: 3002 }, (info) => {
	console.log(`Listening on ${info.address}:${info.port}`);
});

export default app;
```

### [serveStatic](https://github.com/honojs/node-server?tab=readme-ov-file#serve-static-middleware)

```
my-hono-project/
  src/
    index.ts
  static/
    index.html
```

â†‘ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹éš›ã«å‹•ã‹ã™ã®ã¯index.tsã§ã¯ãªãindex.htmlã«ãªã‚‹ã®ã§ã€ãã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

### PipeableStreamã®å‹ã‚’è¦‹ã‚‹

`renderToPipeableStream`ã®è¿”ã‚Šå€¤ã®å‹ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```ts
type PipeableStream = {
  // Cancel any pending I/O and put anything remaining into
  // client rendered mode.
  abort(reason: mixed): void,
  pipe<T: Writable>(destination: T): T,
};
```

pipeã«ã¯`Writable`ãŒå‹å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚å€‹äººçš„ã«ã¯ãªã‚“ã§ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã§ã‚ã–ã‚ã–å®šç¾©ã—ã¦ã„ã‚‹ã®ã‹ãŒã‚ã‹ã£ã¦ãªãã¦ã€å‹ã‚’æ‹¡å¼µã•ã›ã‚‹ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒæœãŸã—ã¦ã‚ã‚‹ã®ã‹ã¨ã„ã†æ°—æŒã¡ã¨ã€ã“ã®é–¢æ•°ã¯Node.jsä¸Šã§ã—ã‹å‹•ã‹ãªã„ã¨æ€ã£ã¦ã„ã‚‹ã®ã§ãã®ã¾ã¾å‹ã‚’ã¤ã‘ã¦ã‚ã’ã‚Œã°ã„ã„ã®ã§ã¯æ€ã£ãŸã‚Šã—ã¦ã„ã¾ã™ğŸ‘€

å°‘ã—è©±ãŒé€¸ã‚ŒãŸã®ã§æˆ»ã™ã¨ã€pipeã®å¼•æ•°ã«ã¯node.jsã®streamã‚’æ¸¡ã—ã¦ã‚ã’ã‚Œã°å‹•ãæ°—é…ãŒã—ã¦ã„ã¾ã™ã€‚

### Honoã§node.jsã®apiã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

> pipeé–¢æ•°ã®å¼•æ•°ã«ã¯node.jsã®streamã‚’æ¸¡ã—ã¦ã‚ã’ã‚Œã°å‹•ã

ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã¯node.jsã®apiã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Honoã§ã¯`c.env.outgoing`ã§å®Ÿç¾ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ref: [https://hono.dev/docs/getting-started/nodejs#access-the-raw-node-js-apis](https://hono.dev/docs/getting-started/nodejs#access-the-raw-node-js-apis)

```js
pipe(c.env.outgoing);
```

ã¤ã¾ã‚Šã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚

### `RESPONSE_ALREADY_SENT`

æœ€å¾Œã«RESPONSE_ALREADY_SENTã‚’returnã—ã¾ã™ã€‚

```ts
import { X_ALREADY_SENT } from './response/constants'
export const RESPONSE_ALREADY_SENT = new Response(null, {
  headers: { [X_ALREADY_SENT]: 'true' },
})
```

å®Ÿè£…ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã€ä½•ã‹ã—ã‚‰returnã—ãªã„ã¨ã„ã‘ãªã„ã®ã§headersã«`[X_ALREADY_SENT]: 'true'`ã‚’è¿½åŠ ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã—ã¦ã„ã‚‹ã ã‘ã®ã‚ˆã†ã§ã™ã­ã€‚
ref: [https://github.com/honojs/node-server?tab=readme-ov-file#direct-response-from-nodejs-api](https://github.com/honojs/node-server?tab=readme-ov-file#direct-response-from-nodejs-api)

ã¡ãªã¿ã«ã“ã‚Œã¯

```ts
export const createAdaptorServer = (options: Options): ServerType => {
  const fetchCallback = options.fetch
  const requestListener = getRequestListener(fetchCallback, {
    hostname: options.hostname,
    overrideGlobalObjects: options.overrideGlobalObjects,
  })
  // ts will complain about createServerHTTP and createServerHTTP2 not being callable, which works just fine
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const createServer: any = options.createServer || createServerHTTP
  const server: ServerType = createServer(options.serverOptions || {}, requestListener)
  return server
}

export const serve = (
  options: Options,
  listeningListener?: (info: AddressInfo) => void
): ServerType => {
  const server = createAdaptorServer(options)
  server.listen(options?.port ?? 3000, options.hostname ?? '0.0.0.0', () => {
    const serverInfo = server.address() as AddressInfo
    listeningListener && listeningListener(serverInfo)
  })
  return server
}
```

â†‘ ã“ã®`serve`é–¢æ•°ã‚’å‘¼ã³å‡ºã—ãŸéš›ã«`createAdaptorServer` â†’ `getRequestListener`ãŒå®Ÿè¡Œã•ã‚Œã¦ã€ãã—ã¦ãã®ä¸­ã«

```js
} else if (resHeaderRecord[X_ALREADY_SENT]) {
  // do nothing, the response has already been sent
```

ã¨ã„ã†å‡¦ç†ãŒã‚ã£ã¦ã€ã€ŒX_ALREADY_SENTãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚Œã°ä½•ã‚‚å®Ÿè¡Œã—ãªã„ã€ã¨ã„ã†å®Ÿè£…ã«ãªã£ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã­ã€‚

## ã¾ã¨ã‚

å¤§ä½“ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚è‡ªåˆ†ã®Streamã«é–¢ã™ã‚‹çŸ¥è­˜ãŒä¹ã—ã„ã®ã§ã‚‚ã—ã‹ã—ãŸã‚‰é–“é•ã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ãŒã€ãã®æ™‚ã¯ãœã²ã”æŒ‡å®šã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

## é–¢é€£

- [https://ja.react.dev/reference/react-dom/server/renderToPipeableStream](https://ja.react.dev/reference/react-dom/server/renderToPipeableStream)
- [https://hono.dev/docs/getting-started/nodejs](https://hono.dev/docs/getting-started/nodejs)
- [https://hono.dev/docs/getting-started/nodejs#access-the-raw-node-js-apis](https://hono.dev/docs/getting-started/nodejs#access-the-raw-node-js-apis)
- [https://github.com/honojs/node-server?tab=readme-ov-file#direct-response-from-nodejs-api](https://github.com/honojs/node-server?tab=readme-ov-file#direct-response-from-nodejs-api)
 
