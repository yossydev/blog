---
title: "CSSNestedDeclarationsというものが入ったらしい"
description: "a"
date: "2024/10/12"
published: true
---

## Intro

[web.dev](https://web.dev/?hl=en)が先日、[CSS nesting improves with CSSNestedDeclarations](https://web.dev/blog/css-nesting-cssnesteddeclarations?hl=en)というブログを公開しました。

このブログでは、CSSネスティングの仕様に[CSSNestedDeclarations]が追加されたことについて書かれています。果たして業務でこのブログで書かれてるバグに出くわすことはなかった気もしますが、CSSOMの動きなど少し面白かったので書くことにしました。

## 話さないこと

この記事では以下の内容については書きません。

- CSS nestingとは
- CSSのparse処理について

## CSS nestingであったバグ

まず既存のCSSネスティングであったバグについてです。
以下のようなCSSを書いた場合、皆さんはどのようなUIになると思いますか？？

```css
.foo {
	width: fit-content;

	@media screen and (min-width: 900px) {
		background-color: red;
	}

	background-color: green;
}
```

関連: [github.com/yossydev/css-nesting-improves-with-cssnesteddeclarations](https://github.com/yossydev/css-nesting-improves-with-cssnesteddeclarations)

この場合、適用されるbackground-colorはred🛑になります。

<img src="https://github.com/user-attachments/assets/d2c31c61-c0fc-4584-a26f-ae813863db64"/>

（左: Chrome129 / 右: Chrome130）

しかしCSSの仕様としては、後ろに書かれたコードが適用となるはずです。これがChrome129までのCSSネスティングのバグとしてありました。

## なぜこのようなバグが存在するのか

なぜこのようなバグが存在していたのでしょうか？
それは、CSSOMを使ったパース処理が関係しています。

先ほどのCSSに対して生成されたCSSOMをみてみましょう。

```
↳ CSSStyleRule
  .type = STYLE_RULE
  .selectorText = ".foo"
  .resolvedSelectorText = ".foo"
  .specificity = (0,1,0)
  .style (CSSStyleDeclaration, 2) =
    - width: fit-content
    - background-color: green
  .cssRules (CSSRuleList, 1) =
    ↳ CSSMediaRule
    .type = MEDIA_RULE
    .cssRules (CSSRuleList, 1) =
      ↳ CSSStyleRule
        .type = STYLE_RULE
        .selectorText = "&"
        .resolvedSelectorText = ":is(.foo)"
        .specificity = (0,1,0)
        .style (CSSStyleDeclaration, 1) =
          - background-color: red
```

`background-color: green`は`CSSStyleRule.style`に含まれているものの、`@media screen`の後に定義されたかどうかはわからないです。そのため、パースされたCSSをみると、以下のようになります。

```
.foo {
  width: fit-content; background-color: green;
  @media screen and (min-width: 900px) {
  & { background-color: red; }
  }
}
```

`background-color: green`が`@media screen`よりも上に来てしまいました。これではCSSの優先順位的に、`min-width: 900px`が正の時はredが適用されます。

（そもそも常に`background-color: green`にしたいなら`background-color: red`いらないのでは？みたいなご意見はごもっともです）


## CSSNestedDeclarationsの追加

## まとめ
