---
title: "WIP 'Introduce to React Compiler' blog."
description: "8/4の若手エンジニアLT&交流会で発表したIntroduce to React Compilerの日本語ブログです。"
date: "2024/08/04"
published: false
---

## Intro

このブログは8/4に行われた[若手エンジニアLT & 交流会](https://devguil.connpass.com/event/321787/)というイベントで発表した、[Introduce to React Compiler]()という資料の日本語ブログです。
資料は基本英語なので、翻訳だと思っていただければ大丈夫です。

内容としてはざっくりReact Compilerの説明を書いてます。[Youtube](https://www.youtube.com/@yossydev)で[React Compiler Code Reading](https://www.youtube.com/watch?v=ZaZb1FhwdxQ&list=PLL3VHi3SOiPv4rpI3yC8tFPlOGukAOz7f)というものもやっており、せっかくなのでそこで見た実際のコードも見ながらこのブログは書きます。

## 話さないこと

今回は以下のことについては話さないです。

- Compilerとは何かの説明
- React Compilerのコードの具体的な話
- Reactのこと
  - メモ化について
  - APIの説明

あと資料の中では自己紹介も入っていますが、このブログでは書かないです。

## React Compilerとは

> React Compiler is a compiler that optimizes React applications, ensuring that only the minimal parts of components and hooks will re-render when state changes. The compiler also validates that components and hooks follow the Rules of React.
>
> ref: [https://github.com/facebook/react/tree/main/compiler#react-compiler](https://github.com/facebook/react/tree/main/compiler#react-compiler)

日本語に訳して説明をすると、つまりReact Compilerとは、**Reactアプリの最適化を行うコンパイラ**のことを指します。

皆さんはこれまでReactアプリの最適化を行う際に、

- [useMemo](https://react.dev/reference/react/useMemo)
- [useCallback](https://react.dev/reference/react/useCallback)
- [React.memo](https://react.dev/reference/react/memo)

のようなReactが提供しているメモ化関数を使って手動で最適化を行ってきたと思います。React Compilerを使えば、自動で最適化を行ってくれるようになるため、開発者によるメモ化は不要になります。そしてこれはReact19でやってやってきます！

## React Compilerを入れることで嬉しいこと

**React CompilerはReactアプリの最適化を自動で行ってくれるもの**ということがわかりました。
では次に、実際にReact Compilerを入れることで我々開発者はどんなことが嬉しいのでしょうか。筆者は二つポイントがあると思っています。

- 手動メモ化からの解放
- コンパイルチェックによるコードの品質担保

それぞれ見ていきましょう。

### 手動メモ化からの解放 

これは先ほども言った内容ですが、React Compilerの目玉機能と言っても過言ではない自動メモ化はメリットとして一番あると思っています。

```tsx
import { memo, useState, useCallback, useMemo } from 'react';

export default function MyApp() {
  const [name, setName] = useState('');
  const [address, setAddress] = useState('');

  const handleSubmit = useCallback((orderDetails) => {
    post('/product/' + productId + '/buy', {
      referrer,
      orderDetails,
    });
  }, [productId, referrer]);

 const visibleTodos = useMemo(
    () => filterTodos(todos, tab),
    [todos, tab]
  );

  return (
    ...簡単のために省略
  );
}

const Greeting = memo(function Greeting({ name }) {
  console.log("Greeting was rendered at", new Date().toLocaleTimeString());
  return <h3>Hello{name && ', '}{name}!</h3>;
});
```

こちらはuseMemo/useCallback/React.memoをそれぞれ使ったみたコードになります（ドキュメントから引っ張ってきたので、若干非現実的なコードにはなっています🙏）

React Compilerを使っている場合は以下のように書けます。

```tsx
import { useState } from 'react';

export default function MyApp() {
  const [name, setName] = useState('');
  const [address, setAddress] = useState('');

  const handleSubmit = (orderDetails) => {
    post('/product/' + productId + '/buy', {
      referrer,
      orderDetails,
    });
  };

 const visibleTodos = () => filterTodos(todos, tab);

  return (
    ...簡単のために省略
  );
}

const Greeting = function Greeting({ name }) {
  console.log("Greeting was rendered at", new Date().toLocaleTimeString());
  return <h3>Hello{name && ', '}{name}!</h3>;
};
```

自動でメモ化してくれるので、シンプルなコードになりました。あとはdepsの管理も不要になるので、単純にバグも減りそうです（`react-hooks/exhaustive-deps`は入れてるといえdepsのバグはあるある）

あと、筆者としては**メモ化するしないのコミュニケーションが減る**ことも良いと思っています。
よく記事でも「こういったケースはメモ化した方が良い」「メモ化は全部はしないほうが良い」というような記事が定期的に出ていたり、業務の中でも「これは〇〇だからメモ化は逆にしないほうが良いのでは」といったレビューをもらった開発者の方は多いのではないでしょうか。筆者も何度かレビューをもらったことがありますが、正直アプリケーションを作る上でメモ化するしないの判断をするのは難しいと思っていたので、自動メモ化の恩恵はこういった部分でも役に立つと思っています。

### コンパイルチェックによるコードの品質担保 

React Compilerは当然ながらコンパイラなため、意図してない、許可していないコードがあればコンパイルが失敗するようになっています。

例えば以下のようなコードは、コンパイルエラーとなります。

```tsx
// ref: https://github.com/facebook/react/blob/main/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-mutate-props-via-for-of-iterator.expect.md
function Component(props) {
  const items = [];
  for (const x of props.items) {
    x.modified = true; // InvalidReact
    items.push(x);
  }
  return items;
}
```

ぜひこのコードを[Playground](https://playground.react.dev/#N4Igzg9grgTgxgUxALhAMygOzgFwJYSYAEAwhALYAOhCmOAFJTBJWAJRHAA6xRchYHETw4E5MEQC8RANoBdANw8iRNBBhF6-TIKIAPIhDREmLMADoRY9p2Ur958hAAmeNHgTOpRHDCgIlXhUrcXNKKDAAC3o9NkCVAF87GAQcWGIQsECEkASgA)で試してみてください。`InvalidReact: Mutating component props or hook arguments is not allowed. Consider using a local variable instead`というエラーになるはずです。しかしこのコードは今までは特に問題なくブラウザでも動作しました。

React Compilerを使うことで、このように事前に安全ではない、意図していないコードを検知することができます。

ちなみに、コンパイル時ではなく編集中にエラーを知りたい！という方には、[eslint-plugin-react-compiler](https://github.com/facebook/react/tree/main/compiler/packages/eslint-plugin-react-compiler)というプラグインがあります。これを使えばReact Compilerによって検出されたエラーをlintとしてチェックすることもできます。React Compilerを使うのであれば、一緒に入れておくと良いでしょう。

## React Compilerのコンパイルの流れ

ここまでで、React Compilerを導入する嬉しさは理解いただけたかと思います。では次に、React Compilerのコンパイルの流れをみていきます。

## React Compilerのこれから

## まとめ

## 関連

- [React Compiler Doc](https://react.dev/learn/react-compiler)
- [react/compiler at main · facebook/react](https://github.com/facebook/react/tree/main/compiler)
- [Introducing React Compiler · reactwg react-compiler · Discussion \#5](https://github.com/reactwg/react-compiler/discussions/5)
